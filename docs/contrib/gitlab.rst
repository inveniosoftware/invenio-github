..
    This file is part of Invenio.
    Copyright (C) 2025 CERN.

    Invenio is free software; you can redistribute it and/or modify it
    under the terms of the MIT License; see LICENSE file for more details.

GitLab
======

To register GitLab as a VCS provider:

* instantiate ``invenio_vcs.contrib.gitlab.GitLabProviderFactory``
* add it into the ``VCS_PROVIDERS`` list
* add it into the ``OAUTHCLIENT_REMOTE_APPS`` and ``OAUTHCLIENT_REST_REMOTE_APPS`` dictionaries under the same key as the ID (``gitlab`` by default).
* configure ``GITLAB_APP_CREDENTIALS`` with your OAuth credentials generated by GitLab.

For more details and a full example, please see `the Usage Guide <../usage>`_.

=============
Compatibility
=============

The integration has been tested to work with the following versions of GitLab:

* 18.x
* 17.x
* 16.x

Support for anything but the latest major version is not guaranteed.
Please refer also to the `GitLab release policy <https://docs.gitlab.com/policy/maintenance/#maintained-versions>`_.

Any modified GitLab instances running custom code are also not guaranteed to be compatible.
You can, however, override the ``invenio_vcs.contrib.gitlab.GitLabProviderFactory`` and ``invenio_vcs.contrib.gitlab.GitLabProvider`` classes to add support for any non-standard API behaviour.

==================
OAuth registration
==================

To register a GitLab VCS provider, you need to `create a new Application <https://gitlab.com/-/user_settings/applications>`_ in your User Settings.
For a self-hosted GitLab instance, navigate to ``https://my-gitlab-instance.com/-/user_settings/applications``.

Configure the app with the following settings:

* You can use any name.
* Use a redirect URI of the form

  .. code-block::

    https://example.com/oauth/authorized/gitlab/

  where ``example.com`` is the hostname of your instance and ``gitlab`` is your configured provider ID.

* Ensure 'Confidential' is checked.
* Select the ``api`` scope. Unfortunately, webhook management doesn't currently have a more narrow scope so this highly-general scope must be selected.

=====================
Special config values
=====================

These optional values can be passed as keys of the ``config`` dictionary in the ``GitHubProviderFactory`` constructor.

* ``shared_validation_token``: Validation secret token for the webhook payload. See the `GitLab documentation <https://docs.gitlab.com/user/project/integrations/webhooks/#create-a-webhook>`_ for more details. Currently, one instance-wide token is used for all webhooks. In addition, an internal per-repository access token is automatically attached to the webhook URL to validate access.
